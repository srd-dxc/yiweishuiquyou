<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一维水平地层非活塞式水驱油</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.9.0/lib/browser/math.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f9fc;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid #2c7ac3;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        h1 {
            color: #2c7ac3;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            font-size: 16px;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .input-panel {
            flex: 1;
            min-width: 350px;
        }
        
        .output-panel {
            flex: 3;
            min-width: 900px;
        }
        
        h2 {
            color: #2c7ac3;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-size: 22px;
        }
        
        h3 {
            color: #4a90e2;
            margin: 15px 0 10px 0;
            font-size: 18px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }
        
        .case-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .case-box {
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .case1-box {
            border-left-color: #2c7ac3;
        }
        
        .case2-box {
            border-left-color: #5cb85c;
        }
        
        .case3-box {
            border-left-color: #f0ad4e;
        }
        
        .case-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .case1-title {
            color: #2c7ac3;
        }
        
        .case2-title {
            color: #5cb85c;
        }
        
        .case3-title {
            color: #f0ad4e;
        }
        
        .calculation-results {
            background-color: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #4a90e2;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        
        .result-item {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .result-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c7ac3;
            margin-top: 5px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 10px;
            color: #555;
            font-weight: 600;
            font-size: 16px;
        }
        
        .chart-subtitle {
            text-align: center;
            margin-bottom: 15px;
            color: #777;
            font-size: 14px;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            background-color: #2c7ac3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #1d5fa0;
        }
        
        .secondary-btn {
            background-color: #6c757d;
        }
        
        .secondary-btn:hover {
            background-color: #5a6268;
        }
        
        .chart-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-item {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .chart-item-wide {
            grid-column: span 2;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 1200px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
            
            .chart-item-wide {
                grid-column: span 1;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .case-inputs, .results-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
        }
        
        .explanation {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #ffc107;
            font-size: 14px;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 3px;
        }
        
        .vertical-line {
            position: absolute;
            width: 2px;
            background-color: rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        
        .vertical-line-label {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            pointer-events: none;
            border: 1px solid #ddd;
        }
        
        .formula {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Cambria', 'Times New Roman', serif;
            text-align: center;
            border-left: 3px solid #2c7ac3;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #ffeaa7;
        }
        
        /* 相渗透率数据表格样式 */
        .permeability-table-container {
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .permeability-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .permeability-table th {
            background-color: #f1f5f9;
            color: #334155;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #e2e8f0;
        }
        
        .permeability-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .permeability-table input {
            width: 100%;
            padding: 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
        }
        
        .permeability-table input:focus {
            border-color: #3b82f6;
            outline: none;
        }
        
        .permeability-table tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        .permeability-table tr:hover {
            background-color: #f1f5f9;
        }
        
        .table-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        
        .table-btn {
            padding: 8px 16px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        
        .table-btn:hover {
            background-color: #3b82f6;
        }
        
        .table-btn-delete {
            background-color: #ef4444;
        }
        
        .table-btn-delete:hover {
            background-color: #dc2626;
        }
        
        .table-btn-add {
            background-color: #10b981;
        }
        
        .table-btn-add:hover {
            background-color: #059669;
        }
        
        .table-btn-reset {
            background-color: #f59e0b;
        }
        
        .table-btn-reset:hover {
            background-color: #d97706;
        }
        
        .intersection-point {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 3px rgba(0,0,0,0.5);
        }
        
        .intersection-label {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <header>
        <h1>一维水平地层非活塞式水驱油</h1>
        <p class="subtitle">非活塞式水驱油渗流规律计算与可视化</p>
    </header>
    
    <div class="container">
        <div class="panel input-panel">
            <h2>输入参数</h2>
            
            <div class="input-group">
                <h3>相渗透率曲线数据（可编辑）</h3>
                <p style="margin-bottom: 10px; font-size: 14px; color: #666;">编辑下表修改相渗透率数据，点击"计算并绘制曲线"更新结果</p>
                
                <div class="table-buttons">
                    <button class="table-btn table-btn-add" id="addRowBtn">添加一行</button>
                    <button class="table-btn table-btn-reset" id="resetTableBtn">恢复默认数据</button>
                    <button class="table-btn table-btn-delete" id="clearTableBtn">清空表格</button>
                </div>
                
                <div class="permeability-table-container">
                    <table class="permeabilityTable" id="permeabilityTable">
                        <thead>
                            <tr>
                                <th>序号</th>
                                <th>含水饱和度 (Sw)</th>
                                <th>水相相对渗透率 (Krw)</th>
                                <th>油相相对渗透率 (Kro)</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="permeabilityTableBody">
                            <!-- 表格行将动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="input-group">
                <h3>三种情况油水粘度</h3>
                <div class="case-inputs">
                    <div class="case-box case1-box">
                        <div class="case-title case1-title">情况 1</div>
                        <label>油粘度 μ<sub>o</sub> (mPa·s)</label>
                        <input type="number" id="mu_o1" value="50.0" step="0.1" min="0">
                        <label>水粘度 μ<sub>w</sub> (mPa·s)</label>
                        <input type="number" id="mu_w1" value="0.5" step="0.1" min="0">
                    </div>
                    
                    <div class="case-box case2-box">
                        <div class="case-title case2-title">情况 2</div>
                        <label>油粘度 μ<sub>o</sub> (mPa·s)</label>
                        <input type="number" id="mu_o2" value="5.0" step="0.1" min="0">
                        <label>水粘度 μ<sub>w</sub> (mPa·s)</label>
                        <input type="number" id="mu_w2" value="0.5" step="0.1" min="0">
                    </div>
                    
                    <div class="case-box case3-box">
                        <div class="case-title case3-title">情况 3</div>
                        <label>油粘度 μ<sub>o</sub> (mPa·s)</label>
                        <input type="number" id="mu_o3" value="0.4" step="0.1" min="0">
                        <label>水粘度 μ<sub>w</sub> (mPa·s)</label>
                        <input type="number" id="mu_w3" value="1.0" step="0.1" min="0">
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <h3>第(2)问参数</h3>
                <label>日注水量 Q<sub>i</sub> (m³/d)</label>
                <input type="number" id="qi" value="160" step="1" min="0">
                
                <label>束缚水饱和度 S<sub>wc</sub></label>
                <input type="number" id="swc" value="0.2" step="0.01" min="0" max="1">
                
                <label>残余油饱和度 S<sub>or</sub></label>
                <input type="number" id="sor" value="0.2" step="0.01" min="0" max="1">
                
                <label>宽度 B (m)</label>
                <input type="number" id="width" value="100" step="1" min="0">
                
                <label>厚度 h (m)</label>
                <input type="number" id="thickness" value="12" step="0.1" min="0">
                
                <label>孔隙度 φ</label>
                <input type="number" id="porosity" value="0.18" step="0.01" min="0" max="1">
                
                <label>注采井距 L (m)</label>
                <input type="number" id="distance" value="600" step="1" min="0">
            </div>
            
            <div class="input-group">
                <h3>第(3)问参数</h3>
                <label>计算时间 t (天)</label>
                <input type="text" id="times" value="100,200,400">
                <p style="font-size: 12px; color: #666; margin-top: 5px;">请输入以逗号分隔的时间值，例如：100,200,400</p>
            </div>
            
            <div class="buttons">
                <button id="calculateBtn">计算并绘制曲线</button>
                <button id="resetBtn" class="secondary-btn">重置所有参数</button>
            </div>
            
            <div class="calculation-results">
                <h3>计算结果对比</h3>
                <div class="results-grid" id="resultsContainer">
                    <!-- 计算结果将动态显示在这里 -->
                </div>
                
                <div class="legend" id="caseLegend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2c7ac3;"></div>
                        <span>情况 1</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #5cb85c;"></div>
                        <span>情况 2</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f0ad4e;"></div>
                        <span>情况 3</span>
                    </div>
                </div>
            </div>
            
            <div class="explanation">
                <h3>计算原理（根据课本6-4题）</h3>
                <p>1. <strong>含水率计算</strong>：f<sub>w</sub> = 1 / [1 + (K<sub>ro</sub>/K<sub>rw</sub>) × (μ<sub>w</sub>/μ<sub>o</sub>)]</p>
                <p>2. <strong>前缘饱和度确定</strong>：从点(S<sub>wc</sub>, 0)向含水率曲线作切线，切点对应的含水饱和度即为前缘饱和度S<sub>wf</sub>。</p>
                <p>3. <strong>水突破时间</strong>：T = B·h·L·φ·(S<sub>wf</sub> - S<sub>wc</sub>) / Q<sub>i</sub></p>
                <p>4. <strong>饱和度分布</strong>（见水前）：x = f'<sub>w</sub>(S<sub>w</sub>) / (φ·A) × ∫Q dt</p>
                <p>5. <strong>饱和度分布</strong>（见水后）：需先求出口端饱和度S<sub>wL</sub>，再计算分布。</p>
                <div class="formula">
                    x = f'<sub>w</sub>(S<sub>w</sub>) / (φ·A) × ∫Q dt
                </div>
                <div class="warning">
                    <strong>注意：</strong>相渗透率数据必须满足Sw单调递增，Krw和Kro在合理范围内(0-1)。编辑数据后点击"计算并绘制曲线"更新结果。
                </div>
            </div>
        </div>
        
        <div class="panel output-panel">
            <h2>输出曲线</h2>
            
            <div class="chart-row">
                <div class="chart-item">
                    <div class="chart-title">图6-1: 油水相对渗透率曲线</div>
                    <div class="chart-container">
                        <canvas id="relativePermeabilityChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-item">
                    <div class="chart-title">图6-2: 不同情况下含水率曲线</div>
                    <div class="chart-container">
                        <canvas id="waterCutChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="chart-row">
                <div class="chart-item">
                    <div class="chart-title">情况1: 前沿饱和度确定</div>
                    <div class="chart-container">
                        <canvas id="frontalSaturationChart1"></canvas>
                    </div>
                </div>
                
                <div class="chart-item">
                    <div class="chart-title">情况2: 前沿饱和度确定</div>
                    <div class="chart-container">
                        <canvas id="frontalSaturationChart2"></canvas>
                    </div>
                </div>
                
                <div class="chart-item">
                    <div class="chart-title">情况3: 前沿饱和度确定</div>
                    <div class="chart-container">
                        <canvas id="frontalSaturationChart3"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="chart-row">
                <div class="chart-item">
                    <div class="chart-title">图6-6: 含水率导数曲线（三种情况）</div>
                    <div class="chart-container">
                        <canvas id="derivativeChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-item-wide">
                    <div class="chart-title">图6-7: 饱和度分布曲线（情况2，t=100,200,400天）</div>
                    <div class="chart-subtitle">根据课本6-4题第(3)问，只计算情况2的饱和度分布</div>
                    <div class="chart-container">
                        <canvas id="saturationDistributionChart"></canvas>
                    </div>
                    <div id="intersectionInfo" style="margin-top: 10px; text-align: center; font-size: 14px; color: #555;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>水驱油理论指南 - 例题6-4交互演示（修正版） | 基于水驱油理论基础</p>
        <p>注：本演示基于理想化模型，实际油藏开发需考虑更多复杂因素</p>
    </footer>

    <script>
        // 默认相渗透率数据（表6-3）
        const defaultPermeabilityData = [
            { Sw: 0.200, Krw: 0.000, Kro: 0.800 },
            { Sw: 0.250, Krw: 0.002, Kro: 0.610 },
            { Sw: 0.300, Krw: 0.009, Kro: 0.470 },
            { Sw: 0.350, Krw: 0.020, Kro: 0.370 },
            { Sw: 0.400, Krw: 0.038, Kro: 0.285 },
            { Sw: 0.450, Krw: 0.051, Kro: 0.220 },
            { Sw: 0.500, Krw: 0.075, Kro: 0.163 },
            { Sw: 0.550, Krw: 0.100, Kro: 0.120 },
            { Sw: 0.600, Krw: 0.132, Kro: 0.081 },
            { Sw: 0.650, Krw: 0.170, Kro: 0.050 },
            { Sw: 0.700, Krw: 0.208, Kro: 0.027 },
            { Sw: 0.750, Krw: 0.251, Kro: 0.010 },
            { Sw: 0.800, Krw: 0.300, Kro: 0.000 }
        ];
        
        // 图表实例
        let relativePermeabilityChart, waterCutChart;
        let frontalSaturationChart1, frontalSaturationChart2, frontalSaturationChart3;
        let derivativeChart, saturationDistributionChart;
        
        // 颜色方案
        const caseColors = {
            case1: '#2c7ac3',
            case2: '#5cb85c',
            case3: '#f0ad4e'
        };
        
        // 从表格获取相渗透率数据
        function getPermeabilityDataFromTable() {
            const tableBody = document.getElementById('permeabilityTableBody');
            const rows = tableBody.querySelectorAll('tr');
            const data = [];
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs.length >= 3) {
                    const Sw = parseFloat(inputs[0].value);
                    const Krw = parseFloat(inputs[1].value);
                    const Kro = parseFloat(inputs[2].value);
                    
                    // 验证数据有效性
                    if (!isNaN(Sw) && !isNaN(Krw) && !isNaN(Kro)) {
                        data.push({ Sw, Krw, Kro });
                    }
                }
            });
            
            // 按Sw排序
            data.sort((a, b) => a.Sw - b.Sw);
            
            return data;
        }
        
        // 渲染相渗透率表格
        function renderPermeabilityTable(data = defaultPermeabilityData) {
            const tableBody = document.getElementById('permeabilityTableBody');
            tableBody.innerHTML = '';
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="number" value="${item.Sw}" step="0.01" min="0" max="1"></td>
                    <td><input type="number" value="${item.Krw}" step="0.001" min="0" max="1"></td>
                    <td><input type="number" value="${item.Kro}" step="0.001" min="0" max="1"></td>
                    <td><button class="table-btn table-btn-delete delete-row-btn">删除</button></td>
                `;
                tableBody.appendChild(row);
            });
            
            // 绑定删除按钮事件
            bindDeleteRowEvents();
        }
        
        // 绑定删除行按钮事件
        function bindDeleteRowEvents() {
            const deleteButtons = document.querySelectorAll('.delete-row-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const tableBody = document.getElementById('permeabilityTableBody');
                    const rows = tableBody.querySelectorAll('tr');
                    
                    // 确保至少保留一行
                    if (rows.length > 1) {
                        row.remove();
                        updateRowNumbers();
                    } else {
                        alert('至少需要保留一行数据！');
                    }
                });
            });
        }
        
        // 更新行号
        function updateRowNumbers() {
            const rows = document.querySelectorAll('#permeabilityTableBody tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }
        
        // 初始化函数
        function init() {
            // 设置默认值
            document.getElementById('mu_o1').value = 50.0;
            document.getElementById('mu_w1').value = 0.5;
            document.getElementById('mu_o2').value = 5.0;
            document.getElementById('mu_w2').value = 0.5;
            document.getElementById('mu_o3').value = 0.4;
            document.getElementById('mu_w3').value = 1.0;
            document.getElementById('qi').value = 160;
            document.getElementById('swc').value = 0.2;
            document.getElementById('sor').value = 0.2;
            document.getElementById('width').value = 100;
            document.getElementById('thickness').value = 12;
            document.getElementById('porosity').value = 0.18;
            document.getElementById('distance').value = 600;
            document.getElementById('times').value = "100,200,400";
            
            // 渲染默认相渗透率表格
            renderPermeabilityTable();
            
            // 绑定按钮事件
            document.getElementById('calculateBtn').addEventListener('click', calculateAndPlot);
            document.getElementById('resetBtn').addEventListener('click', init);
            
            // 绑定表格操作按钮事件
            document.getElementById('addRowBtn').addEventListener('click', addNewRow);
            document.getElementById('resetTableBtn').addEventListener('click', () => {
                renderPermeabilityTable(defaultPermeabilityData);
            });
            document.getElementById('clearTableBtn').addEventListener('click', clearTable);
            
            // 初始计算
            calculateAndPlot();
        }
        
        // 添加新行
        function addNewRow() {
            const tableBody = document.getElementById('permeabilityTableBody');
            const newRow = document.createElement('tr');
            
            // 获取最后一行数据作为参考
            const rows = tableBody.querySelectorAll('tr');
            const lastRow = rows[rows.length - 1];
            let lastSw = 0.8, lastKrw = 0.3, lastKro = 0.0;
            
            if (lastRow) {
                const inputs = lastRow.querySelectorAll('input');
                lastSw = parseFloat(inputs[0].value) + 0.05;
                lastKrw = parseFloat(inputs[1].value);
                lastKro = parseFloat(inputs[2].value);
            }
            
            // 限制最大值
            lastSw = Math.min(lastSw, 1.0);
            
            newRow.innerHTML = `
                <td>${rows.length + 1}</td>
                <td><input type="number" value="${lastSw.toFixed(3)}" step="0.01" min="0" max="1"></td>
                <td><input type="number" value="${lastKrw.toFixed(3)}" step="0.001" min="0" max="1"></td>
                <td><input type="number" value="${lastKro.toFixed(3)}" step="0.001" min="0" max="1"></td>
                <td><button class="table-btn table-btn-delete delete-row-btn">删除</button></td>
            `;
            tableBody.appendChild(newRow);
            
            // 绑定删除按钮事件
            bindDeleteRowEvents();
        }
        
        // 清空表格（只保留一行）
        function clearTable() {
            const tableBody = document.getElementById('permeabilityTableBody');
            tableBody.innerHTML = '';
            
            // 添加一行空白数据
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>1</td>
                <td><input type="number" value="0.200" step="0.01" min="0" max="1"></td>
                <td><input type="number" value="0.000" step="0.001" min="0" max="1"></td>
                <td><input type="number" value="0.800" step="0.001" min="0" max="1"></td>
                <td><button class="table-btn table-btn-delete delete-row-btn">删除</button></td>
            `;
            tableBody.appendChild(newRow);
            
            // 绑定删除按钮事件
            bindDeleteRowEvents();
        }
        
        // 计算含水率
        function calculateWaterCut(Krw, Kro, mu_w, mu_o) {
            if (Krw === 0) return 0;
            return 1 / (1 + (Kro / Krw) * (mu_w / mu_o));
        }
        
        // 计算三种情况的含水率
        function calculateAllWaterCuts(permeabilityData, mu_o1, mu_w1, mu_o2, mu_w2, mu_o3, mu_w3) {
            const waterCuts = {
                case1: [],
                case2: [],
                case3: []
            };
            
            permeabilityData.forEach(data => {
                waterCuts.case1.push(calculateWaterCut(data.Krw, data.Kro, mu_w1, mu_o1));
                waterCuts.case2.push(calculateWaterCut(data.Krw, data.Kro, mu_w2, mu_o2));
                waterCuts.case3.push(calculateWaterCut(data.Krw, data.Kro, mu_w3, mu_o3));
            });
            
            return waterCuts;
        }
        
        // 寻找前缘饱和度（从点(Swc,0)向含水率曲线作切线）
        function findFrontalSaturation(permeabilityData, waterCuts, Swc, caseIndex) {
            let maxSlope = 0;
            let frontalSw = Swc;
            let frontalIndex = 0;
            let frontalFw = 0;
            
            // 找到斜率最大的点（即切线点）
            for (let i = 1; i < permeabilityData.length; i++) {
                const Sw = permeabilityData[i].Sw;
                const fw = waterCuts[i];
                if (fw > 0 && Sw > Swc) { // 只考虑含水率大于0且Sw大于Swc的点
                    const slope = fw / (Sw - Swc);
                    
                    if (slope > maxSlope) {
                        maxSlope = slope;
                        frontalSw = Sw;
                        frontalIndex = i;
                        frontalFw = fw;
                    }
                }
            }
            
            // 计算平均含水饱和度（切线延长至fw=1.0）
            const Sw_avg = Swc + 1 / maxSlope;
            
            return {
                frontalSw,
                frontalFw,
                Sw_avg,
                maxSlope,
                frontalIndex
            };
        }
        
        // 计算水突破时间
        function calculateBreakthroughTime(width, thickness, distance, porosity, Swf, Swc, qi) {
            const A = width * thickness; // 横截面积
            const Vp = A * distance * porosity; // 孔隙体积
            const Qi = qi; // 日注水量
            return Vp * (Swf - Swc) / Qi;
        }
        
        // 计算含水率导数（数值微分）- 中心差分法
        function calculateWaterCutDerivative(permeabilityData, waterCuts) {
            const derivatives = [];
            const SwValues = permeabilityData.map(d => d.Sw);
            
            for (let i = 0; i < waterCuts.length; i++) {
                let derivative;
                if (i === 0) {
                    // 前向差分
                    derivative = (waterCuts[i+1] - waterCuts[i]) / (SwValues[i+1] - SwValues[i]);
                } else if (i === waterCuts.length - 1) {
                    // 后向差分
                    derivative = (waterCuts[i] - waterCuts[i-1]) / (SwValues[i] - SwValues[i-1]);
                } else {
                    // 中心差分（更精确）
                    derivative = (waterCuts[i+1] - waterCuts[i-1]) / (SwValues[i+1] - SwValues[i-1]);
                }
                derivatives.push(derivative);
            }
            
            return derivatives;
        }
        
        // 修正的饱和度分布计算函数（严格按照水驱油理论）
        function calculateSaturationDistributionCase2(permeabilityData, Swc, porosity, width, thickness, qi, times, waterCutsCase2, frontalData2, derivatives2) {
            const A = width * thickness; // 横截面积 m²
            const L = parseFloat(document.getElementById('distance').value); // 注采井距
            const Sor = parseFloat(document.getElementById('sor').value);
            const Sw_max = 1 - Sor; // 最大水饱和度 = 1 - 残余油饱和度
            const distributions = [];
            const breakthroughTime = frontalData2.breakthroughTime;
            const Swf = frontalData2.frontalSw;
            const fwf_derivative = frontalData2.maxSlope; // 前缘处含水率导数，即1/(Swf-Swc)
            
            // 对于每个时间点
            times.forEach(time => {
                const Qcum = qi * time; // 累积注水量 m³
                const distribution = [];
                
                if (time <= breakthroughTime) {
                    // 见水前的情况 - 水驱油
                    // 前缘位置 xf = (fw' * Qcum) / (φ * A)
                    const xf = (fwf_derivative * Qcum) / (porosity * A);
                    
                    // 注入端 (x=0) 处，饱和度为 Sw_max (1-Sor)
                    distribution.push({ Sw: Sw_max, x: 0 });
                    
                    // 对于两相区内的每个饱和度点（从Swf到Sw_max），计算对应的x位置
                    // 注意：饱和度从Sw_max（x=0）变化到Swf（x=xf）
                    const points = [];
                    for (let i = 0; i < permeabilityData.length; i++) {
                        const Sw = permeabilityData[i].Sw;
                        const derivative = derivatives2[i];
                        
                        // 只考虑前缘饱和度到最大饱和度之间的点
                        if (Sw >= Swf && Sw <= Sw_max && derivative > 0) {
                            const x = (derivative * Qcum) / (porosity * A);
                            // 确保x不超过前缘位置
                            if (x <= xf) {
                                points.push({ Sw, x });
                            }
                        }
                    }
                    // 按Sw从大到小排序（即从Sw_max到Swf）
                    points.sort((a, b) => b.Sw - a.Sw);
                    // 将点加入分布，确保Sw递减
                    points.forEach(point => {
                        // 只添加不重复的点
                        if (distribution.length === 0 || 
                            Math.abs(point.Sw - distribution[distribution.length-1].Sw) > 0.001) {
                            distribution.push(point);
                        }
                    });
                    
                    // 确保前缘点存在
                    if (distribution.length === 0 || 
                        Math.abs(distribution[distribution.length-1].Sw - Swf) > 0.001) {
                        // 计算前缘点的精确位置
                        const x_swf = (fwf_derivative * Qcum) / (porosity * A);
                        distribution.push({ Sw: Swf, x: x_swf });
                    }
                    
                    // 前缘后是束缚水区 (x从xf到L，Sw=Swc)
                    distribution.push({ Sw: Swc, x: xf });
                    distribution.push({ Sw: Swc, x: L });
                    
                    // 添加注释：前缘位置
                    distribution.frontalX = xf;
                    distribution.isBreakthrough = false;
                    
                } else {
                    // 见水后的情况 - 水驱油
                    // 需要先求出口端饱和度S_wL
                    // 计算目标导数值：f'_w(S_wL) = (L * φ * A) / Qcum
                    const targetDerivative = (L * porosity * A) / Qcum;
                    
                    // 在Swf到Sw_max之间寻找最接近目标导数值的饱和度
                    let SwL = Swf;
                    let minDiff = Number.MAX_VALUE;
                    let SwL_derivative = 0;
                    
                    for (let i = 0; i < permeabilityData.length; i++) {
                        const Sw = permeabilityData[i].Sw;
                        const derivative = derivatives2[i];
                        if (Sw >= Swf && Sw <= Sw_max) {
                            const diff = Math.abs(derivative - targetDerivative);
                            if (diff < minDiff) {
                                minDiff = diff;
                                SwL = Sw;
                                SwL_derivative = derivative;
                            }
                        }
                    }
                    
                    // 注入端 (x=0) 处，饱和度为 Sw_max
                    distribution.push({ Sw: Sw_max, x: 0 });
                    
                    // 对于两相区内的每个饱和度点，计算对应的x位置
                    // 饱和度从Sw_max减少到SwL，x从0增加到L
                    const points = [];
                    for (let i = 0; i < permeabilityData.length; i++) {
                        const Sw = permeabilityData[i].Sw;
                        const derivative = derivatives2[i];
                        
                        // 只考虑出口端饱和度到最大饱和度之间的点
                        if (Sw >= SwL && Sw <= Sw_max && derivative > 0) {
                            const x = (derivative * Qcum) / (porosity * A);
                            // 确保x不超过井距L
                            if (x <= L) {
                                points.push({ Sw, x });
                            }
                        }
                    }
                    
                    // 按Sw从大到小排序（即从Sw_max到SwL）
                    points.sort((a, b) => b.Sw - b.Sw);
                    
                    // 将点加入分布，确保Sw递减
                    points.forEach(point => {
                        if (distribution.length === 0 || 
                            Math.abs(point.Sw - distribution[distribution.length-1].Sw) > 0.001) {
                            distribution.push(point);
                        }
                    });
                    
                    // 确保出口端饱和度点存在
                    if (distribution.length === 0 || 
                        Math.abs(distribution[distribution.length-1].Sw - SwL) > 0.001) {
                        // 计算出口端饱和度点的位置
                        const x_swL = (SwL_derivative * Qcum) / (porosity * A);
                        distribution.push({ Sw: SwL, x: x_swL });
                    }
                    
                    // 生产井端 (x=L) 处，饱和度为 SwL
                    distribution.push({ Sw: SwL, x: L });
                    
                    // 添加注释
                    distribution.SwL = SwL;
                    distribution.isBreakthrough = true;
                }
                
                // 按x值排序（从小到大）
                distribution.sort((a, b) => a.x - b.x);
                
                distributions.push({
                    time,
                    distribution,
                    breakthroughTime: time <= breakthroughTime
                });
            });
            
            return distributions;
        }
        
        // 扩展相渗透率数据到0-1范围（仅用于绘图显示完整范围）
        function extendPermeabilityDataForPlotting(permeabilityData) {
            if (permeabilityData.length === 0) return permeabilityData;
            
            // 复制原始数据
            const extendedData = [...permeabilityData];
            
            // 获取最小和最大Sw值
            const minSw = Math.min(...permeabilityData.map(d => d.Sw));
            const maxSw = Math.max(...permeabilityData.map(d => d.Sw));
            
            // 如果最小Sw大于0，补充0到minSw的数据
            if (minSw > 0) {
                // 在0到minSw之间添加点
                extendedData.unshift({ Sw: 0, Krw: 0, Kro: permeabilityData[0].Kro });
            }
            
            // 如果最大Sw小于1，补充maxSw到1的数据
            if (maxSw < 1) {
                // 在maxSw到1之间添加点
                const lastData = permeabilityData[permeabilityData.length - 1];
                extendedData.push({ Sw: 1, Krw: lastData.Krw, Kro: 0 });
            }
            
            // 重新排序
            extendedData.sort((a, b) => a.Sw - b.Sw);
            
            return extendedData;
        }
        
        // 计算Swf水平线与饱和度分布曲线的交点
        function calculateIntersectionPoints(distribution, Swf) {
            const intersections = [];
            
            for (let i = 0; i < distribution.length - 1; i++) {
                const point1 = distribution[i];
                const point2 = distribution[i + 1];
                
                // 检查Swf是否在两点之间
                if ((point1.Sw >= Swf && point2.Sw <= Swf) || 
                    (point1.Sw <= Swf && point2.Sw >= Swf)) {
                    
                    // 排除相等的情况
                    if (point1.Sw === point2.Sw) continue;
                    
                    // 线性插值计算交点x坐标
                    const t = (Swf - point1.Sw) / (point2.Sw - point1.Sw);
                    const x = point1.x + t * (point2.x - point1.x);
                    
                    intersections.push({ x, y: Swf });
                }
            }
            
            return intersections;
        }
        
        // 主计算和绘图函数
        function calculateAndPlot() {
            // 获取相渗透率数据
            const permeabilityData = getPermeabilityDataFromTable();
            
            // 验证数据
            if (permeabilityData.length === 0) {
                alert('错误：相渗透率数据为空！请至少输入一行有效数据。');
                return;
            }
            
            // 获取输入参数
            const mu_o1 = parseFloat(document.getElementById('mu_o1').value);
            const mu_w1 = parseFloat(document.getElementById('mu_w1').value);
            const mu_o2 = parseFloat(document.getElementById('mu_o2').value);
            const mu_w2 = parseFloat(document.getElementById('mu_w2').value);
            const mu_o3 = parseFloat(document.getElementById('mu_o3').value);
            const mu_w3 = parseFloat(document.getElementById('mu_w3').value);
            
            const qi = parseFloat(document.getElementById('qi').value);
            const Swc = parseFloat(document.getElementById('swc').value);
            const Sor = parseFloat(document.getElementById('sor').value);
            const width = parseFloat(document.getElementById('width').value);
            const thickness = parseFloat(document.getElementById('thickness').value);
            const porosity = parseFloat(document.getElementById('porosity').value);
            const distance = parseFloat(document.getElementById('distance').value);
            
            const timesStr = document.getElementById('times').value;
            const times = timesStr.split(',').map(t => parseFloat(t.trim()));
            
            // 计算含水率
            const waterCuts = calculateAllWaterCuts(permeabilityData, mu_o1, mu_w1, mu_o2, mu_w2, mu_o3, mu_w3);
            
            // 寻找前缘饱和度（三种情况分别计算）- 使用更精确的切线计算方法
            const frontalData1 = findFrontalSaturation(permeabilityData, waterCuts.case1, Swc, 1);
            const frontalData2 = findFrontalSaturation(permeabilityData, waterCuts.case2, Swc, 2);
            const frontalData3 = findFrontalSaturation(permeabilityData, waterCuts.case3, Swc, 3);
            
            // 计算含水率导数（三种情况分别计算）
            const derivatives1 = calculateWaterCutDerivative(permeabilityData, waterCuts.case1);
            const derivatives2 = calculateWaterCutDerivative(permeabilityData, waterCuts.case2);
            const derivatives3 = calculateWaterCutDerivative(permeabilityData, waterCuts.case3);
            
            // 计算水突破时间（三种情况分别计算）
            const breakthroughTime1 = calculateBreakthroughTime(
                width, thickness, distance, porosity, 
                frontalData1.frontalSw, Swc, qi
            );
            
            const breakthroughTime2 = calculateBreakthroughTime(
                width, thickness, distance, porosity, 
                frontalData2.frontalSw, Swc, qi
            );
            
            const breakthroughTime3 = calculateBreakthroughTime(
                width, thickness, distance, porosity, 
                frontalData3.frontalSw, Swc, qi
            );
            
            // 存储突破时间
            frontalData1.breakthroughTime = breakthroughTime1;
            frontalData2.breakthroughTime = breakthroughTime2;
            frontalData3.breakthroughTime = breakthroughTime3;
            
            // 计算饱和度分布（根据课本6-4题，只计算情况2）
            const saturationDistributionsCase2 = calculateSaturationDistributionCase2(
                permeabilityData, Swc, porosity, width, thickness, qi, times, 
                waterCuts.case2, frontalData2, derivatives2
            );
            
            // 更新计算结果
            updateResults(frontalData1, frontalData2, frontalData3, breakthroughTime1, breakthroughTime2, breakthroughTime3);
            
            // 绘制图表
            drawCharts(permeabilityData, waterCuts, frontalData1, frontalData2, frontalData3, 
                      derivatives1, derivatives2, derivatives3, 
                      saturationDistributionsCase2, times, frontalData2.frontalSw);
        }
        
        // 更新计算结果显示
        function updateResults(frontalData1, frontalData2, frontalData3, breakthroughTime1, breakthroughTime2, breakthroughTime3) {
            const resultsContainer = document.getElementById('resultsContainer');
            
            const results = [
                { 
                    label: "前缘饱和度 S<sub>wf</sub>", 
                    value1: frontalData1.frontalSw.toFixed(4),
                    value2: frontalData2.frontalSw.toFixed(4),
                    value3: frontalData3.frontalSw.toFixed(4)
                },
                { 
                    label: "前缘含水率 f<sub>wf</sub>", 
                    value1: frontalData1.frontalFw.toFixed(4),
                    value2: frontalData2.frontalFw.toFixed(4),
                    value3: frontalData3.frontalFw.toFixed(4)
                },
                { 
                    label: "水突破时间 T (天)", 
                    value1: breakthroughTime1.toFixed(1),
                    value2: breakthroughTime2.toFixed(1),
                    value3: breakthroughTime3.toFixed(1)
                },
                { 
                    label: "无水采收率 E", 
                    value1: ((frontalData1.frontalSw - 0.2) / (1 - 0.2)).toFixed(4),
                    value2: ((frontalData2.frontalSw - 0.2) / (1 - 0.2)).toFixed(4),
                    value3: ((frontalData3.frontalSw - 0.2) / (1 - 0.2)).toFixed(4)
                },
                { 
                    label: "平均含水饱和度 S<sub>w</sub>", 
                    value1: frontalData1.Sw_avg.toFixed(4),
                    value2: frontalData2.Sw_avg.toFixed(4),
                    value3: frontalData3.Sw_avg.toFixed(4)
                },
                { 
                    label: "导数最大值 f'<sub>w</sub>(S<sub>wf</sub>)", 
                    value1: frontalData1.maxSlope.toFixed(4),
                    value2: frontalData2.maxSlope.toFixed(4),
                    value3: frontalData3.maxSlope.toFixed(4)
                }
            ];
            
            let resultsHTML = '';
            results.forEach(result => {
                resultsHTML += `
                <div class="result-item">
                    <div><strong>${result.label}</strong></div>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                        <div style="color: ${caseColors.case1};">${result.value1}</div>
                        <div style="color: ${caseColors.case2};">${result.value2}</div>
                        <div style="color: ${caseColors.case3};">${result.value3}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 5px;">
                        <div>情况1</div>
                        <div>情况2</div>
                        <div>情况3</div>
                    </div>
                </div>
                `;
            });
            
            resultsContainer.innerHTML = resultsHTML;
        }
        
        // 绘制饱和度分布图（图6-7） - 水驱油，添加Swf水平线和交点标记
        function drawSaturationDistributionChart(saturationDistributions, times, Swf) {
            if (saturationDistributionChart) {
                saturationDistributionChart.destroy();
            }
            
            const ctx = document.getElementById('saturationDistributionChart').getContext('2d');
            const L = parseFloat(document.getElementById('distance').value);
            const Sor = parseFloat(document.getElementById('sor').value);
            const Sw_max = 1 - Sor;
            const Swc = parseFloat(document.getElementById('swc').value);
            
            // 准备数据集
            const datasets = [];
            const annotations = [];
            const intersectionPoints = [];
            const intersectionInfo = [];
            
            // 颜色和线型
            const timeColors = ['#2c7ac3', '#5cb85c', '#f0ad4e', '#d9534f'];
            const lineStyles = ['solid', 'dash', 'dot'];
            
            saturationDistributions.forEach((timeData, timeIndex) => {
                const time = timeData.time;
                const distribution = timeData.distribution;
                const color = timeColors[timeIndex % timeColors.length];
                const lineStyle = lineStyles[timeIndex % lineStyles.length];
                
                // 准备数据点
                const dataPoints = distribution.map(point => ({
                    x: point.x,
                    y: point.Sw
                }));
                
                // 添加数据集
                datasets.push({
                    label: `t = ${time} 天`,
                    data: dataPoints,
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointBackgroundColor: color,
                    fill: false,
                    tension: 0, // 不用贝塞尔曲线
                    borderDash: lineStyle === 'dash' ? [5, 5] : 
                               lineStyle === 'dot' ? [2, 2] : [],
                    showLine: true
                });
                
                // 计算Swf水平线与当前曲线的交点
                const intersections = calculateIntersectionPoints(distribution, Swf);
                
                if (intersections.length > 0) {
                    // 对于饱和度分布曲线，可能有多个交点，我们取第一个（最靠近注入端的）
                    const intersection = intersections[0];
                    
                    // 记录交点信息
                    intersectionPoints.push({
                        x: intersection.x,
                        y: intersection.y,
                        color: color,
                        time: time
                    });
                    
                    intersectionInfo.push(`t=${time}天: x<sub>f${timeIndex+1}</sub> = ${intersection.x.toFixed(1)}m`);
                    
                    // 添加交点垂直线的注释
                    annotations.push({
                        type: 'line',
                        mode: 'vertical',
                        scaleID: 'x',
                        value: intersection.x,
                        borderColor: color,
                        borderWidth: 2,
                        borderDash: [3, 3],
                        label: {
                            display: true,
                            content: `x_f${timeIndex+1} = ${intersection.x.toFixed(1)}m`,
                            position: 'top',
                            backgroundColor: color,
                            color: 'white',
                            font: {
                                size: 11
                            }
                        }
                    });
                    
                    // 添加交点点的注释
                    annotations.push({
                        type: 'point',
                        xValue: intersection.x,
                        yValue: intersection.y,
                        backgroundColor: color,
                        borderColor: '#fff',
                        borderWidth: 2,
                        radius: 6
                    });
                }
                
                // 添加前缘位置垂直线注释（见水前）
                if (!timeData.breakthroughTime && distribution.frontalX) {
                    annotations.push({
                        type: 'line',
                        mode: 'vertical',
                        scaleID: 'x',
                        value: distribution.frontalX,
                        borderColor: color,
                        borderWidth: 2,
                        borderDash: [5, 5],
                        label: {
                            display: true,
                            content: `前缘 x_f = ${distribution.frontalX.toFixed(1)}m`,
                            position: 'top',
                            backgroundColor: color,
                            color: 'white',
                            font: {
                                size: 12
                            }
                        }
                    });
                }
                
                // 添加注入端饱和度注释
                const injectionPoint = distribution.find(p => p.x === 0);
                if (injectionPoint) {
                    annotations.push({
                        type: 'point',
                        xValue: 0,
                        yValue: injectionPoint.Sw,
                        backgroundColor: color,
                        borderColor: '#fff',
                        borderWidth: 2,
                        radius: 6,
                        label: {
                            display: true,
                            content: `注入端 S_w=${injectionPoint.Sw.toFixed(3)}`,
                            position: 'right',
                            backgroundColor: color,
                            color: 'white',
                            font: {
                                size: 12
                            }
                        }
                    });
                }
            });
            
            // 添加Swf水平线
            annotations.push({
                type: 'line',
                mode: 'horizontal',
                scaleID: 'y',
                value: Swf,
                borderColor: '#ff6b6b',
                borderWidth: 3,
                borderDash: [5, 5],
                label: {
                    display: true,
                    content: `S_wf = ${Swf.toFixed(3)}`,
                    position: 'right',
                    backgroundColor: '#ff6b6b',
                    color: 'white',
                    font: {
                        size: 13,
                        weight: 'bold'
                    }
                }
            });
            
            // 添加井距位置垂直线
            annotations.push({
                type: 'line',
                mode: 'vertical',
                scaleID: 'x',
                value: L,
                borderColor: '#666',
                borderWidth: 2,
                borderDash: [3, 3],
                label: {
                    display: true,
                    content: `井距 L=${L}m`,
                    position: 'bottom',
                    backgroundColor: '#666',
                    color: 'white',
                    font: {
                        size: 12
                    }
                }
            });
            
            // 添加水平参考线
            annotations.push({
                type: 'line',
                mode: 'horizontal',
                scaleID: 'y',
                value: Sw_max,
                borderColor: '#999',
                borderWidth: 1,
                borderDash: [2, 2],
                label: {
                    display: true,
                    content: `S_w_max = ${Sw_max.toFixed(2)}`,
                    position: 'left',
                    backgroundColor: '#999',
                    color: 'white',
                    font: {
                        size: 11
                    }
                }
            });
            
            annotations.push({
                type: 'line',
                mode: 'horizontal',
                scaleID: 'y',
                value: Swc,
                borderColor: '#999',
                borderWidth: 1,
                borderDash: [2, 2],
                label: {
                    display: true,
                    content: `S_wc = ${Swc.toFixed(2)}`,
                    position: 'left',
                    backgroundColor: '#999',
                    color: 'white',
                    font: {
                        size: 11
                    }
                }
            });
            
            // 显示交点信息
            const intersectionInfoDiv = document.getElementById('intersectionInfo');
            if (intersectionInfo.length > 0) {
                intersectionInfoDiv.innerHTML = `<strong>前缘位置交点:</strong> ${intersectionInfo.join('; ')}`;
            } else {
                intersectionInfoDiv.innerHTML = `<strong>前缘位置交点:</strong> 未找到与Swf=${Swf.toFixed(3)}的交点`;
            }
            
            saturationDistributionChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: '距离 x (m)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            min: 0,
                            max: L * 1.1,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(0) + 'm';
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: '含水饱和度 S_w',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            min: Swc - 0.05,
                            max: Sw_max + 0.05,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                stepSize: 0.1,
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const point = context.raw;
                                    return `${label}: x=${point.x.toFixed(1)}m, S_w=${point.y.toFixed(3)}`;
                                }
                            }
                        },
                        annotation: {
                            annotations: annotations
                        }
                    }
                }
            });
        }
        
        // 绘制所有图表
        function drawCharts(permeabilityData, waterCuts, frontalData1, frontalData2, frontalData3, 
                           derivatives1, derivatives2, derivatives3, 
                           saturationDistributions, times, Swf) {
            // 提取Sw数据
            const SwValues = permeabilityData.map(d => d.Sw);
            const Swc = parseFloat(document.getElementById('swc').value);
            
            // 1. 绘制相对渗透率曲线 - 图6-1（只使用原始数据点）
            if (relativePermeabilityChart) {
                relativePermeabilityChart.destroy();
            }
            
            const ctx1 = document.getElementById('relativePermeabilityChart').getContext('2d');
            
            // 准备数据集 - 只使用原始数据
            const datasets = [
                {
                    label: 'Krw (水相相对渗透率)',
                    data: permeabilityData.map(d => ({ x: d.Sw, y: d.Krw })),
                    borderColor: '#2c7ac3',
                    backgroundColor: 'rgba(44, 122, 195, 0.1)',
                    borderWidth: 3,
                    tension: 0.4, // 平滑线
                    pointRadius: 4, // 数据标记点
                    pointBackgroundColor: '#2c7ac3',
                    showLine: true // 显示连线
                },
                {
                    label: 'Kro (油相相对渗透率)',
                    data: permeabilityData.map(d => ({ x: d.Sw, y: d.Kro })),
                    borderColor: '#d9534f',
                    backgroundColor: 'rgba(217, 83, 79, 0.1)',
                    borderWidth: 3,
                    tension: 0.4, // 平滑线
                    pointRadius: 4, // 数据标记点
                    pointBackgroundColor: '#d9534f',
                    showLine: true // 显示连线
                }
            ];
            
            relativePermeabilityChart = new Chart(ctx1, {
                type: 'scatter', // 使用散点图类型
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: '含水饱和度 Sw'
                            },
                            min: 0, // 强制设置最小值为0
                            max: 1, // 强制设置最大值为1
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                stepSize: 0.1, // 设置刻度间隔为0.1
                                callback: function(value) {
                                    // 显示0和1等关键刻度
                                    if (value === 0 || value === 0.2 || value === 0.4 || value === 0.6 || value === 0.8 || value === 1) {
                                        return value.toFixed(1);
                                    }
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '相对渗透率'
                            },
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(4);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // 2. 绘制含水率曲线 - 图6-2（使用扩展数据确保曲线完整）
            if (waterCutChart) {
                waterCutChart.destroy();
            }
            
            // 为含水率曲线扩展数据到0-1范围
            const extendedPermData = extendPermeabilityDataForPlotting(permeabilityData);
            const extendedSwValues = extendedPermData.map(d => d.Sw);
            
            // 计算扩展数据的含水率
            const mu_o1 = parseFloat(document.getElementById('mu_o1').value);
            const mu_w1 = parseFloat(document.getElementById('mu_w1').value);
            const mu_o2 = parseFloat(document.getElementById('mu_o2').value);
            const mu_w2 = parseFloat(document.getElementById('mu_w2').value);
            const mu_o3 = parseFloat(document.getElementById('mu_o3').value);
            const mu_w3 = parseFloat(document.getElementById('mu_w3').value);
            
            const extendedWaterCuts1 = extendedPermData.map(d => calculateWaterCut(d.Krw, d.Kro, mu_w1, mu_o1));
            const extendedWaterCuts2 = extendedPermData.map(d => calculateWaterCut(d.Krw, d.Kro, mu_w2, mu_o2));
            const extendedWaterCuts3 = extendedPermData.map(d => calculateWaterCut(d.Krw, d.Kro, mu_w3, mu_o3));
            
            const ctx2 = document.getElementById('waterCutChart').getContext('2d');
            waterCutChart = new Chart(ctx2, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '情况1 (μo=50.0, μw=0.5)',
                            data: extendedSwValues.map((sw, i) => ({ x: sw, y: extendedWaterCuts1[i] })),
                            borderColor: caseColors.case1,
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: function(context) {
                                // 原始数据点用大点，扩展数据点不显示
                                const index = context.dataIndex;
                                const Sw = extendedPermData[index].Sw;
                                // 检查是否是原始数据点
                                const isOriginal = permeabilityData.some(d => Math.abs(d.Sw - Sw) < 0.001);
                                return isOriginal ? 4 : 0; // 扩展数据点不显示
                            },
                            pointBackgroundColor: caseColors.case1,
                            showLine: true
                        },
                        {
                            label: '情况2 (μo=5.0, μw=0.5)',
                            data: extendedSwValues.map((sw, i) => ({ x: sw, y: extendedWaterCuts2[i] })),
                            borderColor: caseColors.case2,
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: function(context) {
                                // 原始数据点用大点，扩展数据点不显示
                                const index = context.dataIndex;
                                const Sw = extendedPermData[index].Sw;
                                // 检查是否是原始数据点
                                const isOriginal = permeabilityData.some(d => Math.abs(d.Sw - Sw) < 0.001);
                                return isOriginal ? 4 : 0; // 扩展数据点不显示
                            },
                            pointBackgroundColor: caseColors.case2,
                            showLine: true
                        },
                        {
                            label: '情况3 (μo=0.4, μw=1.0)',
                            data: extendedSwValues.map((sw, i) => ({ x: sw, y: extendedWaterCuts3[i] })),
                            borderColor: caseColors.case3,
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: function(context) {
                                // 原始数据点用大点，扩展数据点不显示
                                const index = context.dataIndex;
                                const Sw = extendedPermData[index].Sw;
                                // 检查是否是原始数据点
                                const isOriginal = permeabilityData.some(d => Math.abs(d.Sw - Sw) < 0.001);
                                return isOriginal ? 4 : 0; // 扩展数据点不显示
                            },
                            pointBackgroundColor: caseColors.case3,
                            showLine: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: '含水饱和度 Sw'
                            },
                            min: 0, // 强制设置最小值为0
                            max: 1, // 强制设置最大值为1
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                stepSize: 0.1, // 设置刻度间隔为0.1
                                callback: function(value) {
                                    // 显示0和1等关键刻度
                                    if (value === 0 || value === 0.2 || value === 0.4 || value === 0.6 || value === 0.8 || value === 1) {
                                        return value.toFixed(1);
                                    }
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '含水率 fw'
                            },
                            beginAtZero: true,
                            max: 1.0,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
            
            // 3. 绘制三种情况的前沿饱和度确定图（使用扩展数据确保曲线完整，提高切线精度）
            drawFrontalSaturationChart('frontalSaturationChart1', extendedPermData, extendedWaterCuts1, frontalData1, Swc, '情况1', caseColors.case1, permeabilityData);
            drawFrontalSaturationChart('frontalSaturationChart2', extendedPermData, extendedWaterCuts2, frontalData2, Swc, '情况2', caseColors.case2, permeabilityData);
            drawFrontalSaturationChart('frontalSaturationChart3', extendedPermData, extendedWaterCuts3, frontalData3, Swc, '情况3', caseColors.case3, permeabilityData);
            
            // 4. 绘制含水率导数曲线（三种情况）- 图6-6（使用扩展数据）
            if (derivativeChart) {
                derivativeChart.destroy();
            }
            
            // 计算扩展数据的导数
            const extendedDerivatives1 = calculateWaterCutDerivative(extendedPermData, extendedWaterCuts1);
            const extendedDerivatives2 = calculateWaterCutDerivative(extendedPermData, extendedWaterCuts2);
            const extendedDerivatives3 = calculateWaterCutDerivative(extendedPermData, extendedWaterCuts3);
            
            const ctx4 = document.getElementById('derivativeChart').getContext('2d');
            derivativeChart = new Chart(ctx4, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '情况1 导数 f\'w(Sw)',
                            data: extendedSwValues.map((sw, i) => ({ x: sw, y: extendedDerivatives1[i] })),
                            borderColor: caseColors.case1,
                            backgroundColor: 'rgba(44, 122, 195, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: function(context) {
                                // 原始数据点用大点，扩展数据点不显示
                                const index = context.dataIndex;
                                const Sw = extendedPermData[index].Sw;
                                // 检查是否是原始数据点
                                const isOriginal = permeabilityData.some(d => Math.abs(d.Sw - Sw) < 0.001);
                                return isOriginal ? 4 : 0; // 扩展数据点不显示
                            },
                            pointBackgroundColor: caseColors.case1,
                            fill: false,
                            showLine: true
                        },
                        {
                            label: '情况2 导数 f\'w(Sw)',
                            data: extendedSwValues.map((sw, i) => ({ x: sw, y: extendedDerivatives2[i] })),
                            borderColor: caseColors.case2,
                            backgroundColor: 'rgba(92, 184, 92, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: function(context) {
                                // 原始数据点用大点，扩展数据点不显示
                                const index = context.dataIndex;
                                const Sw = extendedPermData[index].Sw;
                                // 检查是否是原始数据点
                                const isOriginal = permeabilityData.some(d => Math.abs(d.Sw - Sw) < 0.001);
                                return isOriginal ? 4 : 0; // 扩展数据点不显示
                            },
                            pointBackgroundColor: caseColors.case2,
                            fill: false,
                            showLine: true
                        },
                        {
                            label: '情况3 导数 f\'w(Sw)',
                            data: extendedSwValues.map((sw, i) => ({ x: sw, y: extendedDerivatives3[i] })),
                            borderColor: caseColors.case3,
                            backgroundColor: 'rgba(240, 173, 78, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: function(context) {
                                // 原始数据点用大点，扩展数据点不显示
                                const index = context.dataIndex;
                                const Sw = extendedPermData[index].Sw;
                                // 检查是否是原始数据点
                                const isOriginal = permeabilityData.some(d => Math.abs(d.Sw - Sw) < 0.001);
                                return isOriginal ? 4 : 0; // 扩展数据点不显示
                            },
                            pointBackgroundColor: caseColors.case3,
                            fill: false,
                            showLine: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: '含水饱和度 Sw'
                            },
                            min: 0, // 强制设置最小值为0
                            max: 1, // 强制设置最大值为1
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                stepSize: 0.1, // 设置刻度间隔为0.1
                                callback: function(value) {
                                    // 显示0和1等关键刻度
                                    if (value === 0 || value === 0.2 || value === 0.4 || value === 0.6 || value === 0.8 || value === 1) {
                                        return value.toFixed(1);
                                    }
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '含水率导数 f\'w(Sw)'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(4);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // 5. 绘制饱和度分布曲线（情况2，根据课本）- 使用新函数，传入Swf
            drawSaturationDistributionChart(saturationDistributions, times, Swf);
        }
        
        // 绘制前沿饱和度确定图（提高切线精度）
        function drawFrontalSaturationChart(canvasId, permeabilityData, waterCuts, frontalData, Swc, caseName, caseColor, originalPermeabilityData) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // 如果图表已存在，销毁它
            if (window[canvasId + 'Chart']) {
                window[canvasId + 'Chart'].destroy();
            }
            
            // 改进的切线计算：确保切线准确通过前缘点
            // 切线方程：y = maxSlope * (x - Swc)
            // 其中maxSlope = frontalData.maxSlope
            
            // 计算切线数据点
            const tangentLine = [];
            
            // 切线起点：(Swc, 0)
            tangentLine.push({ x: Swc, y: 0 });
            
            // 切点：(frontalData.frontalSw, frontalData.frontalFw)
            tangentLine.push({ 
                x: frontalData.frontalSw, 
                y: frontalData.frontalFw 
            });
            
            // 切线延长到y=1.0，用于显示平均含水饱和度
            if (frontalData.maxSlope > 0) {
                const x_at_y1 = Swc + 1 / frontalData.maxSlope;
                tangentLine.push({ x: x_at_y1, y: 1.0 });
            }
            
            // 绘制平均含水饱和度点（切线延长至fw=1.0）
            const Sw_avg = frontalData.Sw_avg;
            
            window[canvasId + 'Chart'] = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '含水率曲线 fw(Sw)',
                            data: permeabilityData.map((d, i) => ({ x: d.Sw, y: waterCuts[i] })),
                            borderColor: caseColor,
                            backgroundColor: 'rgba(255, 255, 255, 0)',
                            borderWidth: 3,
                            showLine: true,
                            tension: 0.4,
                            pointRadius: function(context) {
                                // 原始数据点用大点，扩展数据点不显示
                                const index = context.dataIndex;
                                const Sw = permeabilityData[index].Sw;
                                // 检查是否是原始数据点
                                const isOriginal = originalPermeabilityData.some(d => Math.abs(d.Sw - Sw) < 0.001);
                                return isOriginal ? 4 : 0; // 扩展数据点不显示
                            },
                            pointBackgroundColor: caseColor
                        },
                        {
                            label: '切线',
                            data: tangentLine,
                            borderColor: '#d9534f',
                            backgroundColor: 'rgba(217, 83, 79, 0.2)',
                            borderWidth: 2,
                            showLine: true,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: `前缘点 (S_wf=${frontalData.frontalSw.toFixed(3)}, f_wf=${frontalData.frontalFw.toFixed(3)})`,
                            data: [{ x: frontalData.frontalSw, y: frontalData.frontalFw }],
                            backgroundColor: '#d9534f',
                            pointRadius: 8,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: `起点 (S_wc=${Swc.toFixed(2)}, fw=0)`,
                            data: [{ x: Swc, y: 0 }],
                            backgroundColor: caseColor,
                            pointRadius: 8,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: `平均含水饱和度 (S_w=${Sw_avg.toFixed(3)})`,
                            data: [{ x: Sw_avg, y: 1.0 }],
                            backgroundColor: '#f0ad4e',
                            pointRadius: 8,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: '含水饱和度 Sw'
                            },
                            min: 0, // 强制设置最小值为0
                            max: 1, // 强制设置最大值为1
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                stepSize: 0.1 // 设置刻度间隔为0.1
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '含水率 fw'
                            },
                            beginAtZero: true,
                            max: 1.2,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                filter: function(item, chart) {
                                    // 只显示关键图例
                                    return item.text.includes('含水率曲线') || 
                                           item.text.includes('切线') ||
                                           item.text.includes('前缘点') ||
                                           item.text.includes('起点') ||
                                           item.text.includes('平均含水饱和度');
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.x !== null && context.parsed.y !== null) {
                                        label += `Sw=${context.parsed.x.toFixed(3)}, fw=${context.parsed.y.toFixed(3)}`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 初始化页面
        window.onload = init;
    </script>
</body>
</html>
